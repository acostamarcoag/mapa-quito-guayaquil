<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">

    <style>
      html, body, #map { width: 100%; height: 100%; padding: 0; margin: 0; }

      /* Panel flotante (Ir a un punto) */
      .go-panel{
        position:absolute;
        top:12px;
        left:12px;
        z-index: 9999;
        width: min(360px, calc(100vw - 24px));
        background: rgba(255,255,255,0.96);
        border: 1px solid rgba(0,0,0,0.15);
        border-radius: 14px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.18);
        padding: 12px;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }
      .go-panel h3{
        margin:0 0 6px 0;
        font-size: 14px;
      }
      .go-panel .hint{
        margin:0 0 10px 0;
        font-size: 12px;
        color: rgba(0,0,0,.65);
        line-height: 1.35;
      }
      .go-row{
        display:flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .go-input{
        width: 100%;
        padding: 10px 12px;
        border: 1px solid rgba(0,0,0,.15);
        border-radius: 12px;
        font-size: 14px;
        outline: none;
      }
      .go-small{
        width: 110px;
        padding: 10px 12px;
        border: 1px solid rgba(0,0,0,.15);
        border-radius: 12px;
        font-size: 14px;
        outline: none;
      }
      .go-btn{
        padding: 10px 14px;
        border: 0;
        border-radius: 12px;
        background: #2b66ff;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }
      .go-btn.secondary{
        background: transparent;
        border: 1px solid rgba(0,0,0,.15);
        color: #111;
        font-weight: 700;
      }
      .go-tip{
        margin-top: 8px;
        font-size: 12px;
        color: rgba(0,0,0,.55);
      }

      /* En móvil que no tape tanto */
      @media (max-width: 520px){
        .go-panel{ top:auto; bottom: 12px; left: 12px; right: 12px; }
      }
    </style>
    <title>Mapa Guayaquil - Estratos</title>
  </head>

  <body>
    <div id="map"></div>

    <!-- Panel Ir a un punto -->
    <div class="go-panel" id="goPanel">
      <h3>Ir a un punto</h3>
      <p class="hint">Latitud, Longitud (ej: <strong>-2.1894, -79.8891</strong>)</p>

      <input class="go-input" id="coordInput" type="text" placeholder="-2.1894, -79.8891" />

      <div class="go-row" style="margin-top:10px;">
        <button class="go-btn" id="goBtn">Ir</button>
        <button class="go-btn secondary" id="copyLinkBtn">Copiar link</button>

        <div style="display:flex; align-items:center; gap:8px;">
          <label style="font-size:12px; color:rgba(0,0,0,.65);">Zoom:</label>
          <input class="go-small" id="zoomInput" type="number" min="1" max="20" value="16" />
        </div>
      </div>

      <div class="go-tip">Tip: también puedes hacer clic en el mapa para marcar un punto y abrir Street View.</div>
    </div>

    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>

    <!-- Tus capas -->
    <script src="data/0901_guayaquilsec_a_1.js"></script>
    <script src="data/sec_a_simplificado_guayaquil_2.js"></script>

    <script>
      var map = L.map('map', { zoomControl:false, maxZoom:28, minZoom:1 })
        .fitBounds([[-3.055568416534909,-80.79536973971003],[-1.9750666742675484,-79.01703571972902]]);

      var hash = new L.Hash(map);

      map.attributionControl.setPrefix(
        '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
        '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; ' +
        '<a href="https://qgis.org">QGIS</a>'
      );

      var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

      function removeEmptyRowsFromPopupContent(content, feature) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        var rows = tempDiv.querySelectorAll('tr');
        for (var i = 0; i < rows.length; i++) {
          var td = rows[i].querySelector('td.visible-with-data');
          var key = td ? td.id : '';
          if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
            rows[i].parentNode.removeChild(rows[i]);
          }
        }
        return tempDiv.innerHTML;
      }

      function addClassToPopupIfMedia(content, popup) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        var imgTd = tempDiv.querySelector('td img');
        if (imgTd) {
          var src = imgTd.getAttribute('src');
          if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
            popup._contentNode.classList.add('media');
            setTimeout(function() { popup.update(); }, 10);
          } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
            var audio = document.createElement('audio');
            audio.controls = true; audio.src = src;
            imgTd.parentNode.replaceChild(audio, imgTd);
            popup._contentNode.classList.add('media');
            setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
          } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
            var video = document.createElement('video');
            video.controls = true; video.src = src;
            video.style.width = "400px";
            video.style.height = "300px";
            video.style.maxHeight = "60vh";
            video.style.maxWidth = "60vw";
            imgTd.parentNode.replaceChild(video, imgTd);
            popup._contentNode.classList.add('media');
            video.addEventListener('loadedmetadata', function() { popup.update(); });
            setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
          } else {
            popup._contentNode.classList.remove('media');
          }
        } else {
          popup._contentNode.classList.remove('media');
        }
      }

      var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);

      var bounds_group = new L.featureGroup([]);
      function setBounds() {}

      // Basemap
      map.createPane('pane_OpenStreetMap_0');
      map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;

      var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        pane: 'pane_OpenStreetMap_0',
        opacity: 1.0,
        attribution: '',
        minZoom: 1,
        maxZoom: 28,
        minNativeZoom: 0,
        maxNativeZoom: 19
      });
      map.addLayer(layer_OpenStreetMap_0);

      // Capa 1
      function pop_0901_guayaquilsec_a_1(feature, layer) {
        var popupContent = '<table>\
          <tr><td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['fcode'] !== null ? autolinker.link(String(feature.properties['fcode']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['parroquia'] !== null ? autolinker.link(String(feature.properties['parroquia']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['anio'] !== null ? autolinker.link(String(feature.properties['anio']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['fuente'] !== null ? autolinker.link(String(feature.properties['fuente']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['sec'] !== null ? autolinker.link(String(feature.properties['sec']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_hogares'] !== null ? autolinker.link(String(feature.properties['gy_hogares']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_puntaje_prom'] !== null ? autolinker.link(String(feature.properties['gy_puntaje_prom']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_pct_D'] !== null ? autolinker.link(String(feature.properties['gy_pct_D']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_id'] !== null ? autolinker.link(String(feature.properties['gy_id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_estrato_sector'] !== null ? autolinker.link(String(feature.properties['gy_estrato_sector']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
        </table>';

        var content = removeEmptyRowsFromPopupContent(popupContent, feature);
        layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
        layer.bindPopup(content, { maxHeight: 400 });
      }

      function style_0901_guayaquilsec_a_1_0(feature) {
        switch(String(feature.properties['gy_estrato_sector'])) {
          case 'B': return {pane:'pane_0901_guayaquilsec_a_1', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(49,200,89,0.25882352941176473)', interactive:true};
          case 'C+': return {pane:'pane_0901_guayaquilsec_a_1', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(223,212,20,0.26666666666666666)', interactive:true};
          case 'C-': return {pane:'pane_0901_guayaquilsec_a_1', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(105,131,215,0.25882352941176473)', interactive:true};
          case 'D': return {pane:'pane_0901_guayaquilsec_a_1', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(197,1,22,0.22745098039215686)', interactive:true};
          default: return {pane:'pane_0901_guayaquilsec_a_1', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(225,178,35,1.0)', interactive:true};
        }
      }

      map.createPane('pane_0901_guayaquilsec_a_1');
      map.getPane('pane_0901_guayaquilsec_a_1').style.zIndex = 401;
      map.getPane('pane_0901_guayaquilsec_a_1').style['mix-blend-mode'] = 'normal';

      var layer_0901_guayaquilsec_a_1 = new L.geoJson(json_0901_guayaquilsec_a_1, {
        attribution: '',
        interactive: true,
        dataVar: 'json_0901_guayaquilsec_a_1',
        layerName: 'layer_0901_guayaquilsec_a_1',
        pane: 'pane_0901_guayaquilsec_a_1',
        onEachFeature: pop_0901_guayaquilsec_a_1,
        style: style_0901_guayaquilsec_a_1_0
      });
      bounds_group.addLayer(layer_0901_guayaquilsec_a_1);
      map.addLayer(layer_0901_guayaquilsec_a_1);

      // Capa 2 (simplificado)
      function pop_sec_a_simplificado_guayaquil_2(feature, layer) {
        var popupContent = '<table>\
          <tr><td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['fcode'] !== null ? autolinker.link(String(feature.properties['fcode']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['parroquia'] !== null ? autolinker.link(String(feature.properties['parroquia']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['anio'] !== null ? autolinker.link(String(feature.properties['anio']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['fuente'] !== null ? autolinker.link(String(feature.properties['fuente']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['sec'] !== null ? autolinker.link(String(feature.properties['sec']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_hogares'] !== null ? autolinker.link(String(feature.properties['gy_hogares']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_puntaje_prom'] !== null ? autolinker.link(String(feature.properties['gy_puntaje_prom']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_pct_D'] !== null ? autolinker.link(String(feature.properties['gy_pct_D']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_id'] !== null ? autolinker.link(String(feature.properties['gy_id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
          <tr><td colspan="2">' + (feature.properties['gy_estrato_sector'] !== null ? autolinker.link(String(feature.properties['gy_estrato_sector']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>\
        </table>';

        var content = removeEmptyRowsFromPopupContent(popupContent, feature);
        layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
        layer.bindPopup(content, { maxHeight: 400 });
      }

      function style_sec_a_simplificado_guayaquil_2_0(feature) {
        switch(String(feature.properties['gy_estrato_sector'])) {
          case 'B': return {pane:'pane_sec_a_simplificado_guayaquil_2', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(49,200,89,0.25882352941176473)', interactive:true};
          case 'C+': return {pane:'pane_sec_a_simplificado_guayaquil_2', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(223,212,20,0.26666666666666666)', interactive:true};
          case 'C-': return {pane:'pane_sec_a_simplificado_guayaquil_2', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(105,131,215,0.25882352941176473)', interactive:true};
          case 'D': return {pane:'pane_sec_a_simplificado_guayaquil_2', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(197,1,22,0.22745098039215686)', interactive:true};
          default: return {pane:'pane_sec_a_simplificado_guayaquil_2', opacity:1, color:'rgba(35,35,35,1.0)', dashArray:'', lineCap:'butt', lineJoin:'miter', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(225,178,35,1.0)', interactive:true};
        }
      }

      map.createPane('pane_sec_a_simplificado_guayaquil_2');
      map.getPane('pane_sec_a_simplificado_guayaquil_2').style.zIndex = 402;
      map.getPane('pane_sec_a_simplificado_guayaquil_2').style['mix-blend-mode'] = 'normal';

      var layer_sec_a_simplificado_guayaquil_2 = new L.geoJson(json_sec_a_simplificado_guayaquil_2, {
        attribution: '',
        interactive: true,
        dataVar: 'json_sec_a_simplificado_guayaquil_2',
        layerName: 'layer_sec_a_simplificado_guayaquil_2',
        pane: 'pane_sec_a_simplificado_guayaquil_2',
        onEachFeature: pop_sec_a_simplificado_guayaquil_2,
        style: style_sec_a_simplificado_guayaquil_2_0
      });
      bounds_group.addLayer(layer_sec_a_simplificado_guayaquil_2);
      map.addLayer(layer_sec_a_simplificado_guayaquil_2);

      // Control de capas
      var overlaysTree = [
        {label: 'sec_a_simplificado_guayaquil<br /><table><tr><td style="text-align: center;"><img src="legend/sec_a_simplificado_guayaquil_2_B0.png" /></td><td>B</td></tr><tr><td style="text-align: center;"><img src="legend/sec_a_simplificado_guayaquil_2_C1.png" /></td><td>C+</td></tr><tr><td style="text-align: center;"><img src="legend/sec_a_simplificado_guayaquil_2_C2.png" /></td><td>C-</td></tr><tr><td style="text-align: center;"><img src="legend/sec_a_simplificado_guayaquil_2_3.png" /></td><td></td></tr><tr><td style="text-align: center;"><img src="legend/sec_a_simplificado_guayaquil_2_D4.png" /></td><td>D</td></tr></table>', layer: layer_sec_a_simplificado_guayaquil_2},
        {label: '0901_guayaquil — sec_a<br /><table><tr><td style="text-align: center;"><img src="legend/0901_guayaquilsec_a_1_B0.png" /></td><td>B</td></tr><tr><td style="text-align: center;"><img src="legend/0901_guayaquilsec_a_1_C1.png" /></td><td>C+</td></tr><tr><td style="text-align: center;"><img src="legend/0901_guayaquilsec_a_1_C2.png" /></td><td>C-</td></tr><tr><td style="text-align: center;"><img src="legend/0901_guayaquilsec_a_1_3.png" /></td><td></td></tr><tr><td style="text-align: center;"><img src="legend/0901_guayaquilsec_a_1_D4.png" /></td><td>D</td></tr></table>', layer: layer_0901_guayaquilsec_a_1},
        {label: "OpenStreetMap", layer: layer_OpenStreetMap_0, radioGroup: 'bm' }
      ];

      var lay = L.control.layers.tree(null, overlaysTree, { collapsed: true });
      lay.addTo(map);

      setBounds();

      // ==========================
      // IR A UN PUNTO + STREET VIEW
      // ==========================
      var goMarker = null;

      function normalizeCoords(input){
        // acepta: "-2.18, -79.88"  o "-2.18 -79.88"
        var s = (input || "").trim();
        s = s.replace(/\s+/g, " ").replace(";", ",");
        if (s.includes(",")) {
          var parts = s.split(",").map(x => x.trim()).filter(Boolean);
          if (parts.length >= 2) return {lat: parseFloat(parts[0]), lng: parseFloat(parts[1])};
        } else {
          var parts2 = s.split(" ").map(x => x.trim()).filter(Boolean);
          if (parts2.length >= 2) return {lat: parseFloat(parts2[0]), lng: parseFloat(parts2[1])};
        }
        return null;
      }

      function isValidLatLng(lat, lng){
        return Number.isFinite(lat) && Number.isFinite(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
      }

      function buildHashLink(lat, lng, zoom){
        // Leaflet-hash: #z/lat/lng
        return location.origin + location.pathname + "#" + zoom + "/" + lat.toFixed(4) + "/" + lng.toFixed(4);
      }

      function openStreetView(lat, lng){
        // layer=c -> street view
        var url = "https://www.google.com/maps?layer=c&cbll=" + lat + "," + lng;
        window.open(url, "_blank", "noopener");
      }

      function showPointPopup(lat, lng, zoom){
        var lat6 = lat.toFixed(6);
        var lng6 = lng.toFixed(6);
        var link = buildHashLink(lat, lng, zoom);

        var html = `
          <div style="min-width:200px">
            <div><strong>Punto:</strong> ${lat6}, ${lng6}</div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
              <button id="btnSV"
                style="padding:8px 10px; border:0; border-radius:10px; background:#2b66ff; color:#fff; font-weight:700; cursor:pointer;">
                Street View
              </button>
              <button id="btnCopyCoords"
                style="padding:8px 10px; border:1px solid rgba(0,0,0,.2); border-radius:10px; background:#fff; cursor:pointer;">
                Copiar coords
              </button>
              <button id="btnCopyLink"
                style="padding:8px 10px; border:1px solid rgba(0,0,0,.2); border-radius:10px; background:#fff; cursor:pointer;">
                Copiar link
              </button>
            </div>
            <div style="margin-top:6px; font-size:12px; opacity:.75">
              *Street View depende de cobertura de Google.
            </div>
          </div>
        `;

        if (goMarker) {
          goMarker.setLatLng([lat, lng]);
        } else {
          goMarker = L.marker([lat, lng]).addTo(map);
        }

        goMarker.bindPopup(html).openPopup();

        setTimeout(function(){
          var b1 = document.getElementById("btnSV");
          if (b1) b1.onclick = function(){ openStreetView(lat6, lng6); };

          var b2 = document.getElementById("btnCopyCoords");
          if (b2) b2.onclick = async function(){
            try{
              await navigator.clipboard.writeText(lat6 + ", " + lng6);
              b2.textContent = "Copiado ✅";
              setTimeout(()=> b2.textContent = "Copiar coords", 1200);
            }catch(e){
              prompt("Copia estas coordenadas:", lat6 + ", " + lng6);
            }
          };

          var b3 = document.getElementById("btnCopyLink");
          if (b3) b3.onclick = async function(){
            try{
              await navigator.clipboard.writeText(link);
              b3.textContent = "Copiado ✅";
              setTimeout(()=> b3.textContent = "Copiar link", 1200);
            }catch(e){
              prompt("Copia este link:", link);
            }
          };
        }, 50);
      }

      // Clic en el mapa -> marcador + popup con street view
      map.on("click", function(e){
        var z = map.getZoom();
        showPointPopup(e.latlng.lat, e.latlng.lng, z);
      });

      // Botón IR
      document.getElementById("goBtn").addEventListener("click", function(){
        var z = parseInt(document.getElementById("zoomInput").value, 10);
        if (!Number.isFinite(z) || z < 1) z = 16;

        var coords = normalizeCoords(document.getElementById("coordInput").value);
        if (!coords || !isValidLatLng(coords.lat, coords.lng)) {
          alert("Coordenadas inválidas. Usa: -2.1894, -79.8891");
          return;
        }

        map.setView([coords.lat, coords.lng], z, { animate: true });
        showPointPopup(coords.lat, coords.lng, z);
      });

      // Copiar link del estado actual del mapa (zoom/centro)
      document.getElementById("copyLinkBtn").addEventListener("click", async function(){
        var center = map.getCenter();
        var z = map.getZoom();
        var link = buildHashLink(center.lat, center.lng, z);
        try{
          await navigator.clipboard.writeText(link);
          this.textContent = "Copiado ✅";
          setTimeout(()=> this.textContent = "Copiar link", 1200);
        }catch(e){
          prompt("Copia este link:", link);
        }
      });
    </script>
  </body>
</html>