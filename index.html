<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <link rel="stylesheet" href="css/leaflet.photon.css">

  <title>Estratificación socioeconómica - Guayaquil</title>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #app {
      height: 100vh;
      width: 100vw;
      display: flex;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #sidebar {
      width: 360px;
      min-width: 300px;
      max-width: 420px;
      background: #ffffff;
      border-right: 1px solid rgba(0,0,0,.08);
      padding: 14px 14px 10px 14px;
      overflow: auto;
    }
    #map { flex: 1; height: 100%; }

    .h1 { font-size: 16px; font-weight: 800; margin: 0 0 8px 0; }
    .muted { color: rgba(0,0,0,.62); font-size: 12px; }
    .card {
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
      box-shadow: 0 1px 6px rgba(0,0,0,.04);
      background: #fff;
    }
    .kpiRow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi .label { font-size: 12px; color: rgba(0,0,0,.62); margin-bottom: 4px; }
    .kpi .value { font-size: 20px; font-weight: 800; letter-spacing: .2px; }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.05);
      font-size: 12px;
      margin-left: 6px;
    }

    label { display:block; font-size: 12px; color: rgba(0,0,0,.62); margin-bottom: 6px; }
    select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.15);
      background: #fff;
      font-size: 14px;
      outline: none;
    }
    .btnRow { display:flex; gap:10px; margin-top: 10px; }
    .btn {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.15);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }
    .btn.primary { background: #111827; color: #fff; border-color: #111827; }
    .btn:active { transform: translateY(1px); }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px 0; font-size: 13px; }
    th { font-size: 12px; color: rgba(0,0,0,.62); border-bottom: 1px solid rgba(0,0,0,.08); }
    td { border-bottom: 1px dashed rgba(0,0,0,.08); }

    .list {
      margin: 8px 0 0 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag {
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      background: rgba(0,0,0,.02);
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 900px) { #sidebar { width: 320px; } }
    @media (max-width: 720px) {
      #app { flex-direction: column; }
      #sidebar { width: 100%; max-width: none; border-right: none; border-bottom: 1px solid rgba(0,0,0,.08); }
      #map { height: calc(100vh - 420px); min-height: 320px; }
    }
  </style>
</head>

<body>
  <div id="app">
    <aside id="sidebar">
      <div class="card">
        <div class="h1">Dashboard · Estratificación Guayaquil</div>
        <div class="muted">Mapa interactivo (versión inicial). Filtra por estrato y mira hogares + parroquias.</div>
      </div>

      <div class="card">
        <label for="filtroEstrato">Filtro de estrato</label>
        <select id="filtroEstrato">
          <option value="__ALL__">Todos</option>
        </select>

        <div class="btnRow">
          <button class="btn primary" id="btnAplicar">Aplicar</button>
          <button class="btn" id="btnReset">Reset</button>
        </div>

        <div class="muted" style="margin-top:8px">
          Filtro actual:
          <span class="pill" id="pillFiltro">Todos</span>
        </div>
      </div>

      <div class="card">
        <div class="kpiRow">
          <div class="kpi">
            <div class="label">Hogares (filtro)</div>
            <div class="value" id="kpiHogaresFiltro">—</div>
          </div>
          <div class="kpi">
            <div class="label">% del total</div>
            <div class="value" id="kpiPctFiltro">—</div>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">Total hogares (dataset): <b id="kpiHogaresTotal">—</b></div>
      </div>

      <div class="card">
        <div class="h1" style="font-size:14px;margin-bottom:8px">Hogares por estrato</div>
        <table>
          <thead>
            <tr>
              <th>Estrato</th>
              <th>Hogares</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody id="tablaEstratos">
            <tr><td colspan="3" class="muted">—</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h1" style="font-size:14px;margin-bottom:6px">Parroquias dentro del filtro</div>
        <div class="muted">Se muestran las parroquias (nombre) según el código <b>parroquia</b>.</div>
        <ul class="list" id="listaParroquias"></ul>
      </div>

      <div class="card">
        <div class="muted">Autor: Econ. Marco Acosta G</div>
      </div>
    </aside>

    <div id="map"></div>
  </div>

  <!-- Scripts qgis2web -->
  <script src="js/qgis2web_expressions.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/L.Control.Layers.Tree.min.js"></script>
  <script src="js/leaflet.rotatedMarker.js"></script>
  <script src="js/leaflet.pattern.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>
  <script src="js/rbush.min.js"></script>
  <script src="js/labelgun.min.js"></script>
  <script src="js/labels.js"></script>
  <script src="js/leaflet.photon.js"></script>

  <!-- Data (Guayaquil simplificado) -->
  <script src="data/sec_a_simplificado_guayaquil_2.js"></script>

  <script>
    /* ============================
       Parroquias Guayaquil
       (si falta alguna, la muestra como código)
    ============================ */
    var parroquiasGYE = {
      "090101": "Ayacucho",
      "090102": "Bolívar (Sagrario)",
      "090103": "Carbo (Concepción)",
      "090104": "Febres Cordero",
      "090105": "García Moreno",
      "090106": "Letamendi",
      "090107": "Nueve de Octubre",
      "090108": "Olmedo (San Alejo)",
      "090109": "Roca",
      "090110": "Rocafuerte",
      "090111": "Sucre",
      "090112": "Tarqui",
      "090113": "Urdaneta",
      "090114": "Ximena",
      "090115": "Pascuales",

      "090151": "Chongón",
      "090152": "Juan Gómez Rendón",
      "090153": "Morro",
      "090155": "Playas (Gral. Villamil)",
      "090156": "Posorja",
      "090157": "Puná",
      "090158": "Tenguel"
    };

    function parroquiaNombre(codigo) {
      if (codigo == null) return "";
      var c = String(codigo).trim();
      return parroquiasGYE[c] ? parroquiasGYE[c] : c;
    }

    // =============================
    // MAPA
    // =============================
    var map = L.map('map', { zoomControl:false, maxZoom:28, minZoom:1 })
      .fitBounds([[-3.055568416534909,-80.79536973971003],[-1.9750666742675484,-79.01703571972902]]);

    var hash = new L.Hash(map);
    map.attributionControl.setPrefix(
      '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
      '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; ' +
      '<a href="https://qgis.org">QGIS</a>'
    );

    var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

    function removeEmptyRowsFromPopupContent(content, feature) {
      var tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      var rows = tempDiv.querySelectorAll('tr');
      for (var i = 0; i < rows.length; i++) {
        var td = rows[i].querySelector('td.visible-with-data');
        var key = td ? td.id : '';
        if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
          rows[i].parentNode.removeChild(rows[i]);
        }
      }
      return tempDiv.innerHTML;
    }

    function addClassToPopupIfMedia(content, popup) {
      var tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      var imgTd = tempDiv.querySelector('td img');
      if (imgTd) {
        var src = imgTd.getAttribute('src');
        if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
          popup._contentNode.classList.add('media');
          setTimeout(function() { popup.update(); }, 10);
        } else {
          popup._contentNode.classList.remove('media');
        }
      } else {
        popup._contentNode.classList.remove('media');
      }
    }

    L.control.zoom({ position: 'topleft' }).addTo(map);

    map.createPane('pane_OpenStreetMap_0');
    map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
    var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      pane: 'pane_OpenStreetMap_0',
      opacity: 1.0,
      attribution: '',
      minZoom: 1,
      maxZoom: 28,
      minNativeZoom: 0,
      maxNativeZoom: 19
    });
    map.addLayer(layer_OpenStreetMap_0);

    function pop_sec_a_simplificado_guayaquil(feature, layer) {
      var p = feature.properties || {};
      var codPar = (p.parroquia != null ? String(p.parroquia).trim() : "");
      var nomPar = parroquiaNombre(codPar);

      var popupContent = '<table>\
          <tr><th scope="row">sec</th><td class="visible-with-data" id="sec">' + (p.sec != null ? autolinker.link(String(p.sec)) : '') + '</td></tr>\
          <tr><th scope="row">parroquia</th><td>' + (codPar ? autolinker.link(codPar) : '') + (nomPar && nomPar !== codPar ? ('<br><b>' + nomPar + '</b>') : '') + '</td></tr>\
          <tr><th scope="row">estrato</th><td>' + (p.gy_estrato_sector != null ? autolinker.link(String(p.gy_estrato_sector)) : '') + '</td></tr>\
          <tr><th scope="row">hogares</th><td>' + (p.gy_hogares != null ? autolinker.link(String(p.gy_hogares)) : '') + '</td></tr>\
          <tr><th scope="row">puntaje prom</th><td class="visible-with-data" id="gy_puntaje_prom">' + (p.gy_puntaje_prom != null ? autolinker.link(String(p.gy_puntaje_prom)) : '') + '</td></tr>\
        </table>';

      var content = removeEmptyRowsFromPopupContent(popupContent, feature);
      layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
      layer.bindPopup(content, { maxHeight: 400 });
    }

    function style_sec_a_simplificado_guayaquil_0(feature) {
      switch(String(feature.properties['gy_estrato_sector'])) {
        case 'B':
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(49,200,89,0.25882352941176473)', interactive:true };
        case 'C+':
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(223,57,181,0.26666666666666666)', interactive:true };
        case 'C-':
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(105,131,215,0.25882352941176473)', interactive:true };
        case 'D':
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(197,1,22,0.22745098039215686)', interactive:true };
        default:
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(225,178,35,1.0)', interactive:true };
      }
    }

    map.createPane('pane_sec_a_simplificado_guayaquil');
    map.getPane('pane_sec_a_simplificado_guayaquil').style.zIndex = 401;
    map.getPane('pane_sec_a_simplificado_guayaquil').style['mix-blend-mode'] = 'normal';

    var layer_sec_a_simplificado_guayaquil = new L.geoJson(json_sec_a_simplificado_guayaquil_2, {
      attribution: '',
      interactive: true,
      dataVar: 'json_sec_a_simplificado_guayaquil_2',
      layerName: 'layer_sec_a_simplificado_guayaquil',
      pane: 'pane_sec_a_simplificado_guayaquil',
      onEachFeature: pop_sec_a_simplificado_guayaquil,
      style: style_sec_a_simplificado_guayaquil_0,
    });
    map.addLayer(layer_sec_a_simplificado_guayaquil);

    // =============================
    // DASHBOARD + FILTRO
    // =============================
    function toNumber(x) {
      if (x == null) return 0;
      var n = Number(String(x).replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    }
    function normCat(x) { return (x == null) ? '' : String(x).trim(); }
    function fmtInt(n) { return new Intl.NumberFormat('es-EC', { maximumFractionDigits: 0 }).format(n); }
    function fmtPct(n) { return new Intl.NumberFormat('es-EC', { maximumFractionDigits: 1 }).format(n) + '%'; }

    function getAllCategories() {
      var set = new Set();
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        set.add(normCat(f.properties && f.properties.gy_estrato_sector));
      });
      set.delete('');
      return Array.from(set).sort();
    }

    function totalsByCategory() {
      var out = {};
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        var p = f.properties || {};
        var cat = normCat(p.gy_estrato_sector) || '(Sin categoría)';
        var h = toNumber(p.gy_hogares);
        out[cat] = (out[cat] || 0) + h;
      });
      return out;
    }

    function totalHogaresGlobal() {
      var t = 0;
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        t += toNumber((f.properties || {}).gy_hogares);
      });
      return t;
    }

    function uniqueParroquiasByFilter(catFilter) {
      var s = new Set();
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        var p = f.properties || {};
        var cat = normCat(p.gy_estrato_sector);
        if (catFilter === '__ALL__' || cat === catFilter) {
          if (p.parroquia != null && String(p.parroquia).trim() !== '') s.add(String(p.parroquia).trim());
        }
      });
      return Array.from(s);
    }

    function hogaresByFilter(catFilter) {
      var t = 0;
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        var p = f.properties || {};
        var cat = normCat(p.gy_estrato_sector);
        if (catFilter === '__ALL__' || cat === catFilter) t += toNumber(p.gy_hogares);
      });
      return t;
    }

    function applyFilterToLayer(catFilter) {
      layer_sec_a_simplificado_guayaquil.setStyle(function(feature) {
        var base = style_sec_a_simplificado_guayaquil_0(feature);
        if (catFilter === '__ALL__') return base;

        var cat = normCat(feature.properties && feature.properties.gy_estrato_sector);
        if (cat === catFilter) return Object.assign({}, base, { fillOpacity: 0.65, opacity: 1 });
        return Object.assign({}, base, { fillOpacity: 0.06, opacity: 0.2 });
      });
    }

    function renderDashboard(catFilter) {
      var total = totalHogaresGlobal();
      var hf = hogaresByFilter(catFilter);
      var pct = total > 0 ? (hf / total) * 100 : 0;

      document.getElementById('kpiHogaresTotal').textContent = fmtInt(total);
      document.getElementById('kpiHogaresFiltro').textContent = fmtInt(hf);
      document.getElementById('kpiPctFiltro').textContent = fmtPct(pct);

      document.getElementById('pillFiltro').textContent = (catFilter === '__ALL__') ? 'Todos' : catFilter;

      var tb = document.getElementById('tablaEstratos');
      tb.innerHTML = '';
      var byCat = totalsByCategory();
      Object.keys(byCat).sort().forEach(function(cat) {
        var hogares = byCat[cat];
        var p = total > 0 ? (hogares / total) * 100 : 0;
        var tr = document.createElement('tr');
        tr.innerHTML = '<td><b>' + cat + '</b></td><td>' + fmtInt(hogares) + '</td><td>' + fmtPct(p) + '</td>';
        tb.appendChild(tr);
      });

      var cods = uniqueParroquiasByFilter(catFilter);
      cods.sort(function(a,b){
        var na = parroquiaNombre(a).toLowerCase();
        var nb = parroquiaNombre(b).toLowerCase();
        if (na < nb) return -1;
        if (na > nb) return 1;
        return String(a).localeCompare(String(b));
      });

      var ul = document.getElementById('listaParroquias');
      ul.innerHTML = '';
      if (cods.length === 0) {
        var li = document.createElement('li');
        li.className = 'muted';
        li.textContent = 'No hay parroquias para este filtro.';
        ul.appendChild(li);
      } else {
        cods.slice(0, 120).forEach(function(cod) {
          var li = document.createElement('li');
          li.className = 'tag';
          li.title = String(cod);
          li.textContent = parroquiaNombre(cod);
          ul.appendChild(li);
        });
        if (cods.length > 120) {
          var liMore = document.createElement('li');
          liMore.className = 'muted';
          liMore.textContent = '… + ' + (cods.length - 120) + ' más';
          ul.appendChild(liMore);
        }
      }
    }

    (function initUI() {
      var sel = document.getElementById('filtroEstrato');
      getAllCategories().forEach(function(cat) {
        var opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        sel.appendChild(opt);
      });

      function doApply() {
        var v = sel.value;
        applyFilterToLayer(v);
        renderDashboard(v);
      }

      document.getElementById('btnAplicar').addEventListener('click', doApply);
      document.getElementById('btnReset').addEventListener('click', function() {
        sel.value = '__ALL__';
        doApply();
      });

      sel.addEventListener('change', doApply);

      applyFilterToLayer('__ALL__');
      renderDashboard('__ALL__');
    })();
  </script>
</body>
</html>
