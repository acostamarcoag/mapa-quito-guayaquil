<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <link rel="stylesheet" href="css/leaflet.photon.css">

  <title>Estratificación socioeconómica - Guayaquil</title>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #app {
      height: 100vh;
      width: 100vw;
      display: flex;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #sidebar {
      width: 360px;
      min-width: 300px;
      max-width: 420px;
      background: #ffffff;
      border-right: 1px solid rgba(0,0,0,.08);
      padding: 14px 14px 10px 14px;
      overflow: auto;
    }
    #map { flex: 1; height: 100%; }

    .h1 { font-size: 16px; font-weight: 800; margin: 0 0 8px 0; }
    .muted { color: rgba(0,0,0,.62); font-size: 12px; }
    .card {
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
      box-shadow: 0 1px 6px rgba(0,0,0,.04);
      background: #fff;
    }
    .kpiRow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi .label { font-size: 12px; color: rgba(0,0,0,.62); margin-bottom: 4px; }
    .kpi .value { font-size: 20px; font-weight: 800; letter-spacing: .2px; }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.05);
      font-size: 12px;
      margin-left: 6px;
    }

    label { display:block; font-size: 12px; color: rgba(0,0,0,.62); margin-bottom: 6px; }
    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.15);
      background: #fff;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
    }

    .btnRow { display:flex; gap:10px; margin-top: 10px; }
    .btn {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.15);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }
    .btn.primary { background: #111827; color: #fff; border-color: #111827; }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity: .55; cursor: not-allowed; transform: none; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px 0; font-size: 13px; }
    th { font-size: 12px; color: rgba(0,0,0,.62); border-bottom: 1px solid rgba(0,0,0,.08); }
    td { border-bottom: 1px dashed rgba(0,0,0,.08); }

    .list {
      margin: 8px 0 0 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag {
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      background: rgba(0,0,0,.02);
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .miniRow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .miniHint { margin-top: 8px; font-size: 12px; color: rgba(0,0,0,.62); line-height: 1.35; }
    .svRow { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }

    @media (max-width: 900px) { #sidebar { width: 320px; } }
    @media (max-width: 720px) {
      #app { flex-direction: column; }
      #sidebar { width: 100%; max-width: none; border-right: none; border-bottom: 1px solid rgba(0,0,0,.08); }
      #map { height: calc(100vh - 520px); min-height: 320px; }
    }
  </style>
</head>

<body>
  <div id="app">
    <aside id="sidebar">
      <div class="card">
        <div class="h1">Dashboard · Estratificación Guayaquil</div>
        <div class="muted">Mapa interactivo (versión inicial). Filtra por estrato y mira hogares + parroquias.</div>
      </div>

      <div class="card">
        <label for="filtroEstrato">Filtro de estrato</label>
        <select id="filtroEstrato">
          <option value="__ALL__">Todos</option>
        </select>

        <div class="btnRow">
          <button class="btn primary" id="btnAplicar">Aplicar</button>
          <button class="btn" id="btnReset">Reset</button>
        </div>

        <div class="muted" style="margin-top:8px">
          Filtro actual:
          <span class="pill" id="pillFiltro">Todos</span>
        </div>
      </div>

      <div class="card">
        <div class="kpiRow">
          <div class="kpi">
            <div class="label">Hogares (filtro)</div>
            <div class="value" id="kpiHogaresFiltro">—</div>
          </div>
          <div class="kpi">
            <div class="label">% del total</div>
            <div class="value" id="kpiPctFiltro">—</div>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">Total hogares (dataset): <b id="kpiHogaresTotal">—</b></div>
      </div>

      <div class="card">
        <div class="h1" style="font-size:14px;margin-bottom:8px">Hogares por estrato</div>
        <table>
          <thead>
            <tr>
              <th>Estrato</th>
              <th>Hogares</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody id="tablaEstratos">
            <tr><td colspan="3" class="muted">—</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h1" style="font-size:14px;margin-bottom:6px">Parroquias dentro del filtro</div>
        <div class="muted">Se muestran las parroquias (nombre) según el código <b>parroquia</b>.</div>
        <ul class="list" id="listaParroquias"></ul>
      </div>

      <!-- ✅ NUEVO (sin perder nada): Ir a un punto + Street View -->
      <div class="card">
        <div class="h1" style="font-size:14px;margin-bottom:6px">Ir a un punto</div>
        <div class="muted">Latitud, Longitud (ej: -2.1894, -79.8891)</div>

        <div style="margin-top:8px">
          <input id="inputLatLon" type="text" placeholder="-2.1894, -79.8891">
        </div>

        <div class="btnRow">
          <button class="btn primary" id="btnGoPoint">Ir</button>
          <button class="btn" id="btnCopyLink">Copiar link</button>
        </div>

        <div class="miniRow">
          <div>
            <label for="inputZoom" style="margin-top:0">Zoom</label>
            <input id="inputZoom" type="number" min="1" max="28" step="1" value="16">
          </div>
          <div>
            <label style="margin-top:0">Street View</label>
            <button class="btn" id="btnStreetView" disabled>Abrir</button>
          </div>
        </div>

        <div class="miniHint" id="streetHelp">
          Tip: también puedes hacer clic en el mapa para marcar un punto y habilitar Street View.
        </div>
      </div>

      <div class="card">
        <div class="muted">Autor: Econ. Marco Acosta G</div>
      </div>
    </aside>

    <div id="map"></div>
  </div>

  <!-- Scripts qgis2web -->
  <script src="js/qgis2web_expressions.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/L.Control.Layers.Tree.min.js"></script>
  <script src="js/leaflet.rotatedMarker.js"></script>
  <script src="js/leaflet.pattern.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>
  <script src="js/rbush.min.js"></script>
  <script src="js/labelgun.min.js"></script>
  <script src="js/labels.js"></script>
  <script src="js/leaflet.photon.js"></script>

  <!-- Data (Guayaquil simplificado) -->
  <script src="data/sec_a_simplificado_guayaquil_2.js"></script>

  <script>
    /* ============================
       Parroquias Guayaquil
       (si falta alguna, la muestra como código)
    ============================ */
    var parroquiasGYE = {
      "090101": "Ayacucho",
      "090102": "Bolívar (Sagrario)",
      "090103": "Carbo (Concepción)",
      "090104": "Febres Cordero",
      "090105": "García Moreno",
      "090106": "Letamendi",
      "090107": "Nueve de Octubre",
      "090108": "Olmedo (San Alejo)",
      "090109": "Roca",
      "090110": "Rocafuerte",
      "090111": "Sucre",
      "090112": "Tarqui",
      "090113": "Urdaneta",
      "090114": "Ximena",
      "090115": "Pascuales",

      "090151": "Chongón",
      "090152": "Juan Gómez Rendón",
      "090153": "Morro",
      "090155": "Playas (Gral. Villamil)",
      "090156": "Posorja",
      "090157": "Puná",
      "090158": "Tenguel"
    };

    function parroquiaNombre(codigo) {
      if (codigo == null) return "";
      var c = String(codigo).trim();
      return parroquiasGYE[c] ? parroquiasGYE[c] : c;
    }

    // =============================
    // MAPA
    // =============================
    var map = L.map('map', { zoomControl:false, maxZoom:28, minZoom:1 })
      .fitBounds([[-3.055568416534909,-80.79536973971003],[-1.9750666742675484,-79.01703571972902]]);

    var hash = new L.Hash(map);
    map.attributionControl.setPrefix(
      '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
      '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; ' +
      '<a href="https://qgis.org">QGIS</a>'
    );

    var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

    L.control.zoom({ position: 'topleft' }).addTo(map);

    map.createPane('pane_OpenStreetMap_0');
    map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
    var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      pane: 'pane_OpenStreetMap_0',
      opacity: 1.0,
      attribution: '',
      minZoom: 1,
      maxZoom: 28,
      minNativeZoom: 0,
      maxNativeZoom: 19
    });
    map.addLayer(layer_OpenStreetMap_0);

    // =============================
    // POPUP HTML (igual info + Street View)
    // =============================
    function escHtml(s){
      return String(s).replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    function streetViewUrl(lat, lon) {
      // Street View (si hay cobertura en ese punto)
      return 'https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=' + lat + ',' + lon;
    }

    function markerPopupHtml(props, latlng) {
      var p = props || {};
      var codPar = (p.parroquia != null ? String(p.parroquia).trim() : "");
      var nomPar = parroquiaNombre(codPar);
      var lat = Number(latlng.lat).toFixed(6);
      var lon = Number(latlng.lng).toFixed(6);

      var html = ''
        + '<div style="min-width:220px">'
        + '<table style="width:100%;border-collapse:collapse">'
        + '  <tr><th style="text-align:left;padding:6px 0;font-size:12px;color:rgba(0,0,0,.62);border-bottom:1px solid rgba(0,0,0,.08)">Campo</th>'
        + '      <th style="text-align:left;padding:6px 0;font-size:12px;color:rgba(0,0,0,.62);border-bottom:1px solid rgba(0,0,0,.08)">Valor</th></tr>'
        + '  <tr><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">sec</td><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">' + (p.sec != null ? escHtml(p.sec) : '—') + '</td></tr>'
        + '  <tr><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">parroquia</td><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">' + (codPar ? escHtml(codPar) : '—') + (nomPar && nomPar !== codPar ? ('<br><b>' + escHtml(nomPar) + '</b>') : '') + '</td></tr>'
        + '  <tr><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">estrato</td><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">' + (p.gy_estrato_sector != null ? escHtml(p.gy_estrato_sector) : '—') + '</td></tr>'
        + '  <tr><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">hogares</td><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">' + (p.gy_hogares != null ? escHtml(p.gy_hogares) : '—') + '</td></tr>'
        + '  <tr><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">puntaje prom</td><td style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,.08)">' + (p.gy_puntaje_prom != null ? escHtml(p.gy_puntaje_prom) : '—') + '</td></tr>'
        + '</table>'
        + '<div style="margin-top:10px;font-size:12px;color:rgba(0,0,0,.62);line-height:1.35">'
        + 'Street View te muestra la vista a nivel de calle (si Google tiene cobertura) del entorno del punto marcado.'
        + '</div>'
        + '<div style="margin-top:10px;display:flex;gap:8px">'
        + '  <a href="' + streetViewUrl(lat, lon) + '" target="_blank" rel="noopener" '
        + '     style="flex:1;text-align:center;text-decoration:none;font-weight:800;font-size:12px;padding:9px 10px;border-radius:10px;background:#111827;color:#fff;border:1px solid #111827">'
        + '     Ver Street View'
        + '  </a>'
        + '</div>'
        + '<div style="margin-top:8px;font-size:11px;color:rgba(0,0,0,.55)">Coordenadas: ' + lat + ', ' + lon + '</div>'
        + '</div>';

      return html;
    }

    function style_sec_a_simplificado_guayaquil_0(feature) {
      switch(String(feature.properties['gy_estrato_sector'])) {
        case 'B':
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(49,200,89,0.25882352941176473)', interactive:true };
        case 'C+':
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(223,57,181,0.26666666666666666)', interactive:true };
        case 'C-':
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(105,131,215,0.25882352941176473)', interactive:true };
        case 'D':
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(197,1,22,0.22745098039215686)', interactive:true };
        default:
          return { pane:'pane_sec_a_simplificado_guayaquil', opacity:1, color:'rgba(35,35,35,1.0)', weight:1.0, fill:true, fillOpacity:1, fillColor:'rgba(225,178,35,1.0)', interactive:true };
      }
    }

    map.createPane('pane_sec_a_simplificado_guayaquil');
    map.getPane('pane_sec_a_simplificado_guayaquil').style.zIndex = 401;
    map.getPane('pane_sec_a_simplificado_guayaquil').style['mix-blend-mode'] = 'normal';

    var layer_sec_a_simplificado_guayaquil = new L.geoJson(json_sec_a_simplificado_guayaquil_2, {
      attribution: '',
      interactive: true,
      dataVar: 'json_sec_a_simplificado_guayaquil_2',
      layerName: 'layer_sec_a_simplificado_guayaquil',
      pane: 'pane_sec_a_simplificado_guayaquil',
      style: style_sec_a_simplificado_guayaquil_0,
      onEachFeature: function(feature, layer) {
        // ✅ Click en el sector: marca punto + muestra popup con info + Street View
        layer.on('click', function(e) {
          if (e && e.originalEvent) L.DomEvent.stopPropagation(e.originalEvent);
          setPoint(e.latlng);
          openPointPopup(e.latlng, feature.properties || {});
        });
      }
    });
    map.addLayer(layer_sec_a_simplificado_guayaquil);

    // =============================
    // DASHBOARD + FILTRO (NO SE TOCA)
    // =============================
    function toNumber(x) {
      if (x == null) return 0;
      var n = Number(String(x).replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    }
    function normCat(x) { return (x == null) ? '' : String(x).trim(); }
    function fmtInt(n) { return new Intl.NumberFormat('es-EC', { maximumFractionDigits: 0 }).format(n); }
    function fmtPct(n) { return new Intl.NumberFormat('es-EC', { maximumFractionDigits: 1 }).format(n) + '%'; }

    function getAllCategories() {
      var set = new Set();
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        set.add(normCat(f.properties && f.properties.gy_estrato_sector));
      });
      set.delete('');
      return Array.from(set).sort();
    }

    function totalsByCategory() {
      var out = {};
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        var p = f.properties || {};
        var cat = normCat(p.gy_estrato_sector) || '(Sin categoría)';
        var h = toNumber(p.gy_hogares);
        out[cat] = (out[cat] || 0) + h;
      });
      return out;
    }

    function totalHogaresGlobal() {
      var t = 0;
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        t += toNumber((f.properties || {}).gy_hogares);
      });
      return t;
    }

    function uniqueParroquiasByFilter(catFilter) {
      var s = new Set();
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        var p = f.properties || {};
        var cat = normCat(p.gy_estrato_sector);
        if (catFilter === '__ALL__' || cat === catFilter) {
          if (p.parroquia != null && String(p.parroquia).trim() !== '') s.add(String(p.parroquia).trim());
        }
      });
      return Array.from(s);
    }

    function hogaresByFilter(catFilter) {
      var t = 0;
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f) {
        var p = f.properties || {};
        var cat = normCat(p.gy_estrato_sector);
        if (catFilter === '__ALL__' || cat === catFilter) t += toNumber(p.gy_hogares);
      });
      return t;
    }

    function applyFilterToLayer(catFilter) {
      layer_sec_a_simplificado_guayaquil.setStyle(function(feature) {
        var base = style_sec_a_simplificado_guayaquil_0(feature);
        if (catFilter === '__ALL__') return base;

        var cat = normCat(feature.properties && feature.properties.gy_estrato_sector);
        if (cat === catFilter) return Object.assign({}, base, { fillOpacity: 0.65, opacity: 1 });
        return Object.assign({}, base, { fillOpacity: 0.06, opacity: 0.2 });
      });
    }

    function renderDashboard(catFilter) {
      var total = totalHogaresGlobal();
      var hf = hogaresByFilter(catFilter);
      var pct = total > 0 ? (hf / total) * 100 : 0;

      document.getElementById('kpiHogaresTotal').textContent = fmtInt(total);
      document.getElementById('kpiHogaresFiltro').textContent = fmtInt(hf);
      document.getElementById('kpiPctFiltro').textContent = fmtPct(pct);

      document.getElementById('pillFiltro').textContent = (catFilter === '__ALL__') ? 'Todos' : catFilter;

      var tb = document.getElementById('tablaEstratos');
      tb.innerHTML = '';
      var byCat = totalsByCategory();
      Object.keys(byCat).sort().forEach(function(cat) {
        var hogares = byCat[cat];
        var p = total > 0 ? (hogares / total) * 100 : 0;
        var tr = document.createElement('tr');
        tr.innerHTML = '<td><b>' + cat + '</b></td><td>' + fmtInt(hogares) + '</td><td>' + fmtPct(p) + '</td>';
        tb.appendChild(tr);
      });

      var cods = uniqueParroquiasByFilter(catFilter);
      cods.sort(function(a,b){
        var na = parroquiaNombre(a).toLowerCase();
        var nb = parroquiaNombre(b).toLowerCase();
        if (na < nb) return -1;
        if (na > nb) return 1;
        return String(a).localeCompare(String(b));
      });

      var ul = document.getElementById('listaParroquias');
      ul.innerHTML = '';
      if (cods.length === 0) {
        var li = document.createElement('li');
        li.className = 'muted';
        li.textContent = 'No hay parroquias para este filtro.';
        ul.appendChild(li);
      } else {
        cods.slice(0, 120).forEach(function(cod) {
          var li = document.createElement('li');
          li.className = 'tag';
          li.title = String(cod);
          li.textContent = parroquiaNombre(cod);
          ul.appendChild(li);
        });
        if (cods.length > 120) {
          var liMore = document.createElement('li');
          liMore.className = 'muted';
          liMore.textContent = '… + ' + (cods.length - 120) + ' más';
          ul.appendChild(liMore);
        }
      }
    }

    (function initUI() {
      var sel = document.getElementById('filtroEstrato');
      getAllCategories().forEach(function(cat) {
        var opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        sel.appendChild(opt);
      });

      function doApply() {
        var v = sel.value;
        applyFilterToLayer(v);
        renderDashboard(v);
      }

      document.getElementById('btnAplicar').addEventListener('click', doApply);
      document.getElementById('btnReset').addEventListener('click', function() {
        sel.value = '__ALL__';
        doApply();
      });

      sel.addEventListener('change', doApply);

      applyFilterToLayer('__ALL__');
      renderDashboard('__ALL__');
    })();

    // =============================
    // ✅ PUNTO + STREET VIEW (sin perder nada)
    // =============================
    var pointMarker = null;
    var pointPopup = null;
    var lastPoint = null;

    function setStreetViewEnabled(enabled, latlng) {
      var btn = document.getElementById('btnStreetView');
      btn.disabled = !enabled;
      if (!enabled) return;
      btn.onclick = function() {
        var lat = Number(latlng.lat).toFixed(6);
        var lon = Number(latlng.lng).toFixed(6);
        window.open(streetViewUrl(lat, lon), '_blank', 'noopener');
      };
    }

    function updateUrlPoint(latlng) {
      try {
        var url = new URL(window.location.href);
        url.searchParams.set('p', Number(latlng.lat).toFixed(6) + ',' + Number(latlng.lng).toFixed(6));
        url.searchParams.set('z', String(map.getZoom()));
        history.replaceState(null, '', url.toString());
      } catch (e) {}
    }

    function setPoint(latlng) {
      lastPoint = latlng;

      if (!pointMarker) {
        pointMarker = L.marker(latlng, { draggable: false }).addTo(map);
      } else {
        pointMarker.setLatLng(latlng);
      }

      // refleja en input
      document.getElementById('inputLatLon').value =
        Number(latlng.lat).toFixed(6) + ', ' + Number(latlng.lng).toFixed(6);

      // Street View habilitado
      setStreetViewEnabled(true, latlng);

      // actualiza URL (para que copiar link sea exacto)
      updateUrlPoint(latlng);
    }

    function openPointPopup(latlng, props) {
      var html = markerPopupHtml(props, latlng);
      pointPopup = L.popup({ maxWidth: 340 })
        .setLatLng(latlng)
        .setContent(html)
        .openOn(map);
    }

    function parseLatLon(text) {
      if (!text) return null;
      var t = String(text).trim()
        .replace(/\s+/g, ' ')
        .replace(';', ',');
      var parts = t.split(',').map(function(x){ return x.trim(); }).filter(Boolean);
      if (parts.length < 2) {
        // intenta con espacio
        parts = t.split(' ').map(function(x){ return x.trim(); }).filter(Boolean);
      }
      if (parts.length < 2) return null;
      var lat = Number(parts[0]);
      var lon = Number(parts[1]);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return L.latLng(lat, lon);
    }

    // ===== point-in-polygon (para "Ir a un punto" con info del sector)
    function computeBBox(coords, bbox) {
      bbox = bbox || {minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity};
      if (typeof coords[0] === 'number' && typeof coords[1] === 'number') {
        var x = coords[0], y = coords[1];
        if (x < bbox.minX) bbox.minX = x;
        if (y < bbox.minY) bbox.minY = y;
        if (x > bbox.maxX) bbox.maxX = x;
        if (y > bbox.maxY) bbox.maxY = y;
        return bbox;
      }
      for (var i=0;i<coords.length;i++) computeBBox(coords[i], bbox);
      return bbox;
    }

    function pointInRing(pt, ring) {
      // pt: [lon, lat]
      var x = pt[0], y = pt[1];
      var inside = false;
      for (var i = 0, j = ring.length - 1; i < ring.length; j = i++) {
        var xi = ring[i][0], yi = ring[i][1];
        var xj = ring[j][0], yj = ring[j][1];

        var intersect = ((yi > y) !== (yj > y)) &&
          (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function pointInPolygonCoords(pt, polyCoords) {
      // polyCoords: [ [ring], [hole], ... ]
      if (!polyCoords || !polyCoords.length) return false;
      if (!pointInRing(pt, polyCoords[0])) return false;
      for (var h=1; h<polyCoords.length; h++) {
        if (pointInRing(pt, polyCoords[h])) return false;
      }
      return true;
    }

    var featureIndex = (function buildFeatureIndex(){
      var idx = [];
      (json_sec_a_simplificado_guayaquil_2.features || []).forEach(function(f){
        var g = f.geometry || {};
        var bbox = computeBBox(g.coordinates);
        idx.push({ feature: f, bbox: bbox });
      });
      return idx;
    })();

    function findFeatureAtLatLng(latlng) {
      var pt = [latlng.lng, latlng.lat]; // lon, lat
      for (var i=0; i<featureIndex.length; i++) {
        var item = featureIndex[i];
        var b = item.bbox;
        if (pt[0] < b.minX || pt[0] > b.maxX || pt[1] < b.minY || pt[1] > b.maxY) continue;

        var g = (item.feature.geometry || {});
        if (g.type === 'Polygon') {
          if (pointInPolygonCoords(pt, g.coordinates)) return item.feature;
        } else if (g.type === 'MultiPolygon') {
          for (var k=0; k<g.coordinates.length; k++) {
            if (pointInPolygonCoords(pt, g.coordinates[k])) return item.feature;
          }
        }
      }
      return null;
    }

    // Click en el mapa (cualquier lugar): marca punto + habilita Street View + si cae dentro de un sector, muestra su info
    map.on('click', function(e) {
      setPoint(e.latlng);
      var f = findFeatureAtLatLng(e.latlng);
      if (f && f.properties) openPointPopup(e.latlng, f.properties);
      else openPointPopup(e.latlng, {}); // igual muestra Street View + coords
    });

    // UI: Ir a un punto
    document.getElementById('btnGoPoint').addEventListener('click', function() {
      var latlng = parseLatLon(document.getElementById('inputLatLon').value);
      if (!latlng) {
        alert('Formato inválido. Usa: latitud, longitud  (ej: -2.1894, -79.8891)');
        return;
      }
      var z = Number(document.getElementById('inputZoom').value);
      if (!Number.isFinite(z)) z = 16;

      map.setView(latlng, Math.max(1, Math.min(28, z)));
      setPoint(latlng);

      var f = findFeatureAtLatLng(latlng);
      if (f && f.properties) openPointPopup(latlng, f.properties);
      else openPointPopup(latlng, {});
    });

    // UI: Copiar link
    document.getElementById('btnCopyLink').addEventListener('click', async function() {
      try {
        var url = new URL(window.location.href);
        // asegura que el link tenga punto y zoom si ya existe
        if (lastPoint) {
          url.searchParams.set('p', Number(lastPoint.lat).toFixed(6) + ',' + Number(lastPoint.lng).toFixed(6));
          url.searchParams.set('z', String(map.getZoom()));
        }
        var text = url.toString();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          document.getElementById('streetHelp').textContent = '✅ Link copiado. Compártelo para abrir el mapa en el mismo punto.';
          setTimeout(function(){
            document.getElementById('streetHelp').textContent = 'Tip: también puedes hacer clic en el mapa para marcar un punto y habilitar Street View.';
          }, 3500);
        } else {
          window.prompt('Copia este link:', text);
        }
      } catch (e) {
        window.prompt('Copia este link:', window.location.href);
      }
    });

    // UI: Street View (botón)
    document.getElementById('btnStreetView').addEventListener('click', function() {
      if (!lastPoint) return;
      var lat = Number(lastPoint.lat).toFixed(6);
      var lon = Number(lastPoint.lng).toFixed(6);
      window.open(streetViewUrl(lat, lon), '_blank', 'noopener');
    });

    // Restaurar punto desde URL (?p=lat,lon&z=16)
    (function restoreFromUrl(){
      try {
        var url = new URL(window.location.href);
        var p = url.searchParams.get('p');
        var z = url.searchParams.get('z');
        if (!p) return;

        var latlng = parseLatLon(p);
        if (!latlng) return;

        var zoom = Number(z);
        if (!Number.isFinite(zoom)) zoom = 16;

        map.setView(latlng, Math.max(1, Math.min(28, zoom)));
        setPoint(latlng);

        var f = findFeatureAtLatLng(latlng);
        if (f && f.properties) openPointPopup(latlng, f.properties);
        else openPointPopup(latlng, {});
      } catch (e) {}
    })();
  </script>
</body>
</html>
